# ClamAV Antivirus Scan Script
# Scans for malware and viruses in the codebase using Docker

# Initialize scan environment using scan directory approach
$ScriptDir = Split-Path -Parent $MyInvocation.MyCommand.Path

# Source the scan directory template
. "$ScriptDir\Scan-Directory-Template.ps1"

# Initialize scan environment for clamav
$scanEnv = Initialize-ScanEnvironment -ToolName "clamav"

# Extract scan information
if ($env:SCAN_ID) {
    $parts = $env:SCAN_ID -split '_'
    $TARGET_NAME = $parts[0]
    $USERNAME = $parts[1]
    $TIMESTAMP = $parts[2..($parts.Length-1)] -join '_'
    $SCAN_ID = $env:SCAN_ID
}
else {
    $targetPath = if ($env:TARGET_DIR) { $env:TARGET_DIR } else { Get-Location }
    $TARGET_NAME = Split-Path -Leaf $targetPath
    $USERNAME = if ($env:USERNAME) { $env:USERNAME } else { $env:USER }
    $TIMESTAMP = Get-Date -Format "yyyy-MM-dd_HH-mm-ss"
    $SCAN_ID = "${TARGET_NAME}_${USERNAME}_${TIMESTAMP}"
}

# Configuration - Support target directory override
$RepoPath = if ($env:TARGET_DIR) { $env:TARGET_DIR } else { Get-Location }
# Configuration
# $OUTPUT_DIR set by Initialize-ScanEnvironment
# $SCAN_LOG set by Initialize-ScanEnvironment
$InfectedLog = Join-Path $OUTPUT_DIR "clamav-infected.log"

# Create output directory if it doesn't exist
# Output directory created by template

Write-Host "============================================"
Write-Host "Starting ClamAV antivirus scan..."
Write-Host "============================================"
Write-Host "Repository: $RepoPath"
Write-Host "Output Directory: $OUTPUT_DIR"
Write-Host "Scan Log: $SCAN_LOG"
Write-Host ""

Write-Host "Updating ClamAV virus definitions..."
Write-Host ""

# First, update virus definitions
docker run --rm `
  -v clamav-db:/var/lib/clamav `
  clamav/clamav-debian:latest `
  freshclam

if ($LASTEXITCODE -ne 0) {
  Write-Host "    Warning: Failed to update virus definitions. Proceeding with existing definitions..."
}

Write-Host ""
Write-Host "Running ClamAV scan..."
Write-Host ""

# Run ClamAV scan using Docker
# --infected: Only show infected files
# --recursive: Scan directories recursively
# --log: Log scan results
# --exclude-dir: Exclude specific directories
docker run --rm `
  -v "${RepoPath}:/scan" `
  -v clamav-db:/var/lib/clamav `
  -v "${PWD}\${OutputDir}:/reports" `
  clamav/clamav-debian:latest `
  clamscan `
  --recursive `
  --infected `
  --log=/reports/clamav-scan.log `
  --exclude-dir=node_modules `
  --exclude-dir=.git `
  --exclude-dir=dist `
  --exclude-dir=build `
  --exclude-dir=coverage `
  --exclude-dir=clamav-reports `
  --exclude-dir=trufflehog-reports `
  /scan 2>&1

$ScanExitCode = $LASTEXITCODE

Write-Host ""
Write-Host "============================================"

# Parse results based on exit code
if ($ScanExitCode -eq 0) {
  Write-Host "  ClamAV scan completed successfully!" -ForegroundColor Green
  Write-Host "============================================"
  Write-Host "   No malware or viruses detected!" -ForegroundColor Green
} elseif ($ScanExitCode -eq 1) {
  Write-Host "    ClamAV scan completed with threats detected!" -ForegroundColor Yellow
  Write-Host "============================================"
  Write-Host "   MALWARE/VIRUSES FOUND! Check the detailed logs." -ForegroundColor Red
  
  # Extract infected files from log
  if (Test-Path $SCAN_LOG) {
    Write-Host ""
    Write-Host "Infected files:"
    Write-Host "==============="
    Select-String -Path $SCAN_LOG -Pattern "FOUND" | Tee-Object -FilePath $InfectedLog
  }
} else {
  Write-Host "  ClamAV scan failed with error code: $ScanExitCode" -ForegroundColor Red
  Write-Host "============================================"
}

# Display summary if scan log exists
if (Test-Path $SCAN_LOG) {
  Write-Host ""
  Write-Host "Scan Summary:"
  Write-Host "============="
  
  # Extract summary information from log
  $LogContent = Get-Content $SCAN_LOG -Raw
  if ($LogContent -match "SCAN SUMMARY") {
    $LogContent -split "`n" | Select-String -Pattern "SCAN SUMMARY|End Date:" -Context 0,10
  } else {
    # Fallback: count files and infected
    $ScannedFiles = (Select-String -Path $SCAN_LOG -Pattern "OK$" -AllMatches).Matches.Count
    $InfectedFiles = (Select-String -Path $SCAN_LOG -Pattern "FOUND$" -AllMatches).Matches.Count
    
    Write-Host "Scanned files: $ScannedFiles"
    Write-Host "Infected files: $InfectedFiles"
  }
  
  Write-Host ""
  Write-Host "Detailed results saved to: $SCAN_LOG"
  
  if ((Test-Path $InfectedLog) -and ((Get-Item $InfectedLog).Length -gt 0)) {
    Write-Host "Infected files list: $InfectedLog"
  }
} else {
  Write-Host ""
  Write-Host "    No scan log generated. Check Docker configuration." -ForegroundColor Yellow
}

Write-Host ""
Write-Host "============================================"
Write-Host "ClamAV scan complete."
Write-Host "============================================"
